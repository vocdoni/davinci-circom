pragma circom 2.0.0;

template MiMC(nRounds) {
    signal input x_in;
    signal input k;
    signal output x_out;

    var c[62];
    c[0] = 65891792208677874868253727054504470032541323436439548575235723216963490656283;
    c[1] = 36105173743233688698131949103649244090345277209041204920111145905001535976522;
    c[2] = 56867948320228639798753835118156303182023219935179853253674651517737458069651;
    c[3] = 62512508917969098609543577289746055718807741438804260724496205250788676001250;
    c[4] = 796636033841689627732941016044857384234234277501564259311815186813195010627;
    c[5] = 50826277908896052807607039263888665669592121977576798876911971151186688859055;
    c[6] = 60780580860404956309177266295055417036156007041746140110574446110866579309035;
    c[7] = 35998511508388700277878971790839128648971885531453996832238860174110999500586;
    c[8] = 18183635788335456259215276538456634373878691301055828686319747253615002143747;
    c[9] = 82758998975030479601527754622757768385390164623698187017957701305980595138549;
    c[10] = 65382883075099701756783080987258078756450216380982338649980113358176820674800;
    c[11] = 33371039706946221131896823154266650957676829319224235349015363695502653828989;
    c[12] = 27784357766073635059728385796861499742120237254666505754545151839970885540792;
    c[13] = 95596730213649780132088432142353139401936326870472415677268163088359527885579;
    c[14] = 75429956412636164012463936549446724137637766184929779892105967534443423708587;
    c[15] = 53756670416588032625130506499896742995820521959165839718839135326130705292183;
    c[16] = 8231877132811199596376758288825197494440517476607659739835166243301765860904;
    c[17] = 30223310548319093064739878503818077231292662776236544245657048097083269710716;
    c[18] = 76506274435749379798421735409909804463165580437550398381683643182205499099431;
    c[19] = 46995617475566511394300326641238164871541143367719457816773415138333621271747;
    c[20] = 65721533371070812311828401848401376814025805304511816539974114026033301451353;
    c[21] = 24951837112955150822420714280003084691491188104457662492267359070982612582724;
    c[22] = 44798714887565164996336052489647074475980705852117274701961354191356129714933;
    c[23] = 23136191045676110836006240309618629991309058328625141899547107734177934105284;
    c[24] = 78354775957861033653454722685608632857451324041952681949507496922395661975275;
    c[25] = 9456585747207468967136341612034989517427340607940281880317747335469436896657;
    c[26] = 76220408518141568632454596629152240319528158659240512941638705303308506421846;
    c[27] = 95195117211188532826136277012325278817903066197030587585285018651060860411714;
    c[28] = 56572771112030328855650227823093253882811375213068954528231761697869456490522;
    c[29] = 75585646340842681681368163693587292277624957474982115467111180733877000560471;
    c[30] = 23695014760607119623043369899422738076382158967206163960603825989257726801270;
    c[31] = 46013673779249068644868612837662889441038680454184704525526819406675648535145;
    c[32] = 49936260613467856394876689344648752276855256947718527879134989889891277632770;
    c[33] = 2159153222189174173490067225063044363535871059524538695070191871847470955412;
    c[34] = 113237895596719402334318174152773153832094426374132344017618864048579106432063;
    c[35] = 58832689938132621622225758560895348682919870491144618764908512041344807642010;
    c[36] = 106400668631899717665583083504518566095208985018359928518651132017790287698813;
    c[37] = 49787234927188522622322107555384700074367351894124720727557178620562534391947;
    c[38] = 106126857505227489473777476646065441663191932347222156374345564532609561169631;
    c[39] = 67567719023151986117714583712451557331943651266427959874150859638310515840253;
    c[40] = 5056480146405086811789505170440731715530475328844870175949109998024731067467;
    c[41] = 37628669125748141255858804556043629663603700493080743476086886521178409664319;
    c[42] = 22379493041209909337294800237323296776350200286970403006721311082791718194262;
    c[43] = 49032225639651844112524374030073760153036978285463701695560534780433245223849;
    c[44] = 90546845854849550954966748958327662290604839311391991282823712982425654326195;
    c[45] = 67068643500300074762748307218009641581651842554379282559067772877438917137927;
    c[46] = 100467027847850460312750318617189532544713933264407221112063212216820893693297;
    c[47] = 90470375852145267933180042569389950086854823242126798446994308049277603807906;
    c[48] = 86448832041468256492268132935126749377098367357427856344672009012289901117260;
    c[49] = 1316449090346410801845183915381769525990226349513436734911941391785200212382;
    c[50] = 63667517818031673195860903387234373316749622981848718083202456546644703848572;
    c[51] = 27703289250348329807600342298890287349371575249526359663711151044583275024741;
    c[52] = 75007396561603547419971509241244526369938513415398979322164815434992608715344;
    c[53] = 68884994827910862497901019996763258870329099527919992867450436814828326118018;
    c[54] = 70794215356499436222304229833064025337799635994091193477002937896133496171063;
    c[55] = 54141984986161053132408284106460572512562671742489710067408470580666324663603;
    c[56] = 114052290343727851674598300772814815138805966616555911084848222847061498055347;
    c[57] = 99827415844394147622710843401872172080652093709386853485982741208982887975856;
    c[58] = 46220507494397991460322008572454961645000370540482720081569452719902337199420;
    c[59] = 15143675381185307178500906868356334825651015737618718091251777377451213407009;
    c[60] = 99851315973347117422995835650346542991835428590399002037420549750826045230393;
    c[61] = 66072520702479281240875174265129972029009409906673932231954813276438570258961;

    signal x[nRounds + 1];
    signal t[nRounds];
    signal t2[nRounds];
    signal t4[nRounds];
    signal t8[nRounds];
    signal t16[nRounds];

    x[0] <== x_in;
    for (var i=0; i<nRounds; i++) {
        // m = (m+k+c)**17
        t[i] <== x[i] + k + c[i];
        t2[i] <== t[i] * t[i];
        t4[i] <== t2[i] * t2[i];
        t8[i] <== t4[i] * t4[i];
        t16[i] <== t8[i] * t8[i];
        x[i+1] <== t16[i] * t[i];
    }
    x_out <== x[nRounds] + k;
}

template MultiMiMC(n, nRounds) {
    signal input in[n];
    signal input k;
    signal output out;

    component mimc[n];
    signal h[n+1];

    h[0] <== k;

    for (var i=0; i<n; i++) {
        mimc[i] = MiMC(nRounds);
        mimc[i].x_in <== in[i];
        mimc[i].k <== h[i];
        h[i+1] <== mimc[i].x_out + h[i] + in[i];
    }

    out <== h[n];
}
template MiMC7(nRounds) {
    component m = MiMC(nRounds);
    signal input x_in;
    signal input k;
    signal output x_out;
    m.x_in <== x_in; m.k <== k; x_out <== m.x_out;
}
template MultiMiMC7(n, nRounds) {
    component m = MultiMiMC(n, nRounds);
    signal input in[n];
    signal input k;
    signal output out;
    for(var i=0; i<n; i++) m.in[i] <== in[i]; m.k <== k; out <== m.out;
}
